---
title: "PRA2- Tipologia de Dades"
author: "Joana Llauradó & Maria Sopena Rios"
date: "2024-01-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr);library(ggplot2)
```

# PRA2- Diferencies inter-individuals entre factors de risc per malalties cardiovasculars 

En aquesta pràctica utilitzarem el dataset lliure *Indicators of Heart Disease* de Keggel. Aquest dataset conté les dades de l'enquesta anual del 2020 de la CDC de més de 300.000 adults sobre el seu estat de salut. En aquesta pràctica ens volem:
- **Estudi de variables categòriques**: Estudiar la presencia de malalties (Cardiovascular, Infart, Diabetes, Athma, Malalria Renal i Cancer de Pell) estratificada per sexe,ascendència
- **Estudi de variables numèriques**: Estudiar com factors com les hores de son, l'activitat física, fumar o l'ingesta d'alcohol poden afectar la salut mental i física

## 1. Descripció del dataset 
```{r descripció del dataset}
df <- read.csv("heart_2020_cleaned.csv")
dim(df)
head(df)
colnames(df)
```
Aquest dataset conté informació de 319,795 pacients, un nombre molt elevat que ens ens permetrà fer anàlisis estadísticament molt robustos. Per altra banda, tenim 18 columnes que contenen informació sobre aquests pacients: 

- **HeartDisease**: Presència de malaltia cardiovascular
- **BMI**: Index de massa corporal 
- **Smoking**: Persona fumadora 
- **"AlcoholDrinking"**: Persona que ingereix alcohol
- **Stroke**: Pacient que ha patit un atac de cor
- **PhysicalHealth**: Índex que indica l'estat de salut física 
- **MentalHealth**:  Índex que indica l'estat de salut física 
- **DiffWalking**: Dificultat en caminar 
- **Sex**: Sexe del pacient 
- **AgeCategory**: Categoria d'edat
- **Race"**: Ascencència 
- **Diabetic**: Pacient diabètic 
- **PhysicalActivity**: Activitat físca 
- **GenHealth**: estat de salut general 
- **"SleepTime"**: Hores dormides 
- **Asthma**: Pacient amb asma 
- **"KidneyDisease**: Pacient amb malaltia renal 
-**"SkinCancer**: Cancer de pell

## 2. Integració i selecció del dataset 

## 3. Neteja de dades 

3.1. Les dades contenen 0 o elements buits? 
```{r data cleaning}
table(is.na(df))
```

3.2.Distribució de valors 

Numèriques 

```{r data cleaning2}

numeric_columns <- df[sapply(df, is.numeric)]

# Setting up a single row for subplots
par(mfrow=c(1, 1), mar=c(4, 4, 2, 2))  # Adjust the 'mar' parameter for margin space

# Creating boxplots for each numeric variable in a single plot with different y-axes
boxplot(numeric_columns, main="Boxplots for Numeric Variables", col=1:length(colnames(numeric_columns)), names=colnames(numeric_columns))


categorical_columns <- df[sapply(df, function(x) is.factor(x) | is.character(x))]

# Setting up a layout for multiple plots
par(mfrow=c(2, 2))  # You can adjust the dimensions based on the number of categorical variables

# Creating barplots for each categorical variable
for (column in colnames(categorical_columns)) {
  # Calculate percentages
  percentages <- table(df[[column]]) / nrow(df) * 100
  
  # Create barplot
  barplot(percentages, main=paste("Barplot of", column), xlab=column, ylab="Percentage")
}

# Reset the layout for the next plot
par(mfrow=c(1, 1))
```

```{r data cleaning3}
categorical_columns <- df[sapply(df, function(x) is.factor(x) | is.character(x))]

# Setting up a layout for multiple plots
par(mfrow=c(2, 2))  # You can adjust the dimensions based on the number of categorical variables

# Creating barplots for each categorical variable
for (column in colnames(categorical_columns)) {
  # Calculate percentages
  percentages <- table(df[[column]]) / nrow(df) * 100
  
  # Create barplot
  barplot(percentages, main=paste("Barplot of", column), xlab=column, ylab="Percentage")
}

# Reset the layout for the next plot
par(mfrow=c(1, 1))
```
3.3. Convertim la columna de diabetes a dos categories 
```{r data cleaning4}
df[df$Diabetic == "No, borderline diabetes", ]$Diabetic <- "No"
df[df$Diabetic == "Yes (during pregnancy)", ]$Diabetic <- "Yes"

```

3.3. Convertim la columna de GeneralHealth a numèrica per poder fer correlacions després: 
```{r data cleaning4}
unique(df$GenHealth)
#Excellent -> 5
#Very good -> 4
#Good -> 3 
#Fair -> 2
#Poor -> 1
gen_health_mapping <- c("Poor" = 1, "Fair" = 2, "Good" = 3, "Very good" = 4, "Excellent" = 5)

# Apply the mapping to create a new column
df <- df %>%
  mutate(GenHealth_numeric = factor(GenHealth, levels = names(gen_health_mapping), labels = gen_health_mapping))

```

## 4. Anàlisi de dades 

### 4.1. Variació inter-individual en la presència de malalties 

En aquest anàlisi volem veure si hi ha alguna variable (Sexe, Edat o Raça) que té més influència en alguna de les malalties. Primer farem una visualització de les dades: 

**Sexe**

Mostra la distribució de presencia/absència de malaltia per sexe 
```{r Sexe}
females  <- df %>% filter(Sex == "Female") %>% select(HeartDisease, Stroke, Diabetic, Asthma, KidneyDisease, SkinCancer) %>% pivot_longer(cols = c(HeartDisease, Stroke, Diabetic, Asthma, KidneyDisease, SkinCancer), names_to = "disease", values_to = "yes_no")

females$Sex <- "Females"

males  <- df %>% filter(Sex == "Male") %>% select(HeartDisease, Stroke, Diabetic, Asthma, KidneyDisease, SkinCancer) %>% pivot_longer(cols = c(HeartDisease, Stroke, Diabetic, Asthma, KidneyDisease, SkinCancer), names_to = "disease", values_to = "yes_no")
males$Sex <- "Males"

df_males_females <- rbind(females, males)

ggplot(df_males_females, aes(disease, fill=yes_no))+geom_bar(stat="count", position="fill")+facet_grid(~Sex)

```
De la gent que té una malaltia, quin és el percentage d'homes i dones? 

```{r malaltia per sexe}

vars <- c("HeartDisease", "Stroke", "Diabetic", "Asthma", "KidneyDisease", "SkinCancer")

new_df <- c("Disease"=NULL, "Sex"=NULL)
for(var in vars){
  df_var <- df[, c(var, "Sex")]
  df_var <- df_var[df_var[var] == "Yes",]
  df_var$Disease <- var
  df_var <- df_var[,-1]
  new_df <- rbind(new_df, df_var)
}

ggplot(new_df, aes(x=Disease, fill=Sex))+geom_bar(stat="count", position = "fill")+ylab("Proportion")+theme_minimal()+ggtitle("Proportion of diseased patients colored by sex")
```
Aquests resultats ens mostren que tot i que la distribució per malaltia entre sexes és sobre el 50% en la majoria dels casos, veiem que sembla que en Asma positiu hi hagi un major percentage de dones i en HeartDisease d'homes. Fem un **ChiSquare** test per veure si hi ha una assocació entre sexe i aquestes malalties i per tant podem dir quehi ha un sexe que té més risc que un altre a patir aquesta malaltia. 

Primer fem el test amb Asma: 
```{r asma}
contingency_table_Astma <- table(df$Sex, df$Asthma)
chisq.test(contingency_table_Astma)
```
Els resultats ens mostren un p-valor significatiu que ens permet rebutjar la hipòtesi nul·la i per tant podem dir que hi ha una associació entre Sexe i Asma 

Ara fem el test amb Malaltia Cardiovascular 
```{r malaltia cardiovascular}
contingency_table_HeartDisease<- table(df$Sex, df$HeartDisease)
chisq.test(contingency_table_Astma)
```
Un altre cop obtenim resultats significatius que ens permeten afirmar que hi ha assocació entre Sexe i malaltia cardiovascular 


```{r skin cancer}
contingency_table_HeartDisease<- table(df$Sex, df$SkinCancer)
chisq.test(contingency_table_Astma)
```
**Ancestry**

Hi ha molts estudis que associen el color de pell amb un increment de risk de patir cancer de pell (https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7087065/). Per tant, en aquesta part del nostre estudi ens volem enfocar en veure com de forta és la influència del color de pell (en aquest cas agafarem la raça) en la presència de cancer de pell. Per fer-ho utilitzarem una regressió logística amb Race com a variable predictiva corregint per Sexe, Edat i Fumadors (s'ha vist que fumar pot ser un factor de risk del cancer de pell) que podrien ser possibles confounders. 

Primer però anem a fer una inspecció visual de les dades. 

```{r data cleaning}
ancestry  <- df %>% select(Race, SkinCancer) 

ggplot(ancestry, aes(Race, fill=SkinCancer))+geom_bar(stat="count", position="fill")+theme_minimal()

```
Tal com esperàvem, hi ha un percentage més alt de persones amb pell blanc que tenen cancer de pell. Ara procedim a fer el model per veure com de forta és la influència del color de pell: 


```{r data cleaning}
# Convertim skin cancer a binari 
df$SkinCancer <- ifelse(df$SkinCancer == "Yes", 1, 0 )
df$SkinCancer  <- as.factor(df$SkinCancer )
df$Race <- as.factor(df$Race)
df$Sex <- as.factor(df$Sex)
df$AgeCategory <- as.factor(df$AgeCategory)
df$AgeCategory <- as.factor(df$AgeCategory)

# Fit logistic regression model
model <- glm(SkinCancer ~ Race + Sex + AgeCategory + Smoking, data = df, family = "binomial")

# Display model summary
summary(model)
```

Els resultats d'aquest model ens mostren, tal com esperàvem, que Race contribueix significativament al cancer en tots els casos. Si ens fixem en el primer valor (Estimate) podem saber si l'associació és positiva o negativa. Aquest valor fa referència al log odds ratio de l'associació, el simbol ens indica si aquesta associació és positiva o negativa i el número la intensitat d'aquesta. Per tant veiem que *RaceAsian*, *RaceBlack*, *RaceHispanic* tenen una associació negativa, és a dir, en menys risc de càncer sent la raça negra la associació més forta. En canvi, *RaceOthers* i *RaceWhite* tenen una associació positivia suggerint un increment del risc en aquests dos grups racials. 

Inesperadament, també trobem una associació significativa amb Homes i en totes les franges d'edat fet que corrobora la necessitat de posar aquestes variables al model per evitar resultats falsos i confusos. 

### 4.2. Factors que contribueixen a la salut mental i física 

Podem fer correlacions i tal 

